<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2024"><meta name="DC.rights.owner" content="(C) Copyright 2024"><meta name="DC.Type" content="concept"><meta name="DC.Relation" scheme="URI" content="../topics/impala_performance.html"><meta name="prodname" content="Impala"><meta name="prodname" content="Impala"><meta name="version" content="Impala 3.4.x"><meta name="version" content="Impala 3.4.x"><meta name="DC.Format" content="XHTML"><meta name="DC.Identifier" content="perf_skew"><link rel="stylesheet" type="text/css" href="../css/commonltr.css"><link rel="stylesheet" type="text/css" href="../css/dita-ot-doc.css"><title>Detecting and Correcting HDFS Block Skew Conditions</title></head><body id="perf_skew"><header role="banner"><!--
The DITA Open Toolkit is licensed for use under the the Apache
Software Foundation License v2.0.

A copy of the Apache Software Foundation License 2.0 is
available at http://opensource.org/licenses/apache2.0.php

This statement must be included in any copies of DITA Open
Toolkit code.
--><div class="header">
  <p>Apache Impala</p>
  <hr>
</div></header><nav role="toc"><ul><li><a href="../topics/impala_intro.html">Introducing Apache Impala</a></li><li><a href="../topics/impala_concepts.html">Concepts and Architecture</a></li><li><a href="../topics/impala_planning.html">Deployment Planning</a></li><li><a href="../topics/impala_install.html">Installing Impala</a></li><li><a href="../topics/impala_config.html">Managing Impala</a></li><li><a href="../topics/impala_upgrading.html">Upgrading Impala</a></li><li><a href="../topics/impala_processes.html">Starting Impala</a></li><li><a href="../topics/impala_tutorial.html">Tutorials</a></li><li><a href="../topics/impala_admin.html">Administration</a></li><li><a href="../topics/impala_security.html">Impala Security</a></li><li><a href="../topics/impala_langref.html">SQL Reference</a></li><li><a href="../topics/impala_performance.html">Performance Tuning</a><ul><li><a href="../topics/impala_perf_cookbook.html">Performance Best Practices</a></li><li><a href="../topics/impala_perf_joins.html">Join Performance</a></li><li><a href="../topics/impala_perf_stats.html">Table and Column Statistics</a></li><li><a href="../topics/impala_perf_benchmarking.html">Benchmarking</a></li><li><a href="../topics/impala_perf_resources.html">Controlling Resource Usage</a></li><li><a href="../topics/impala_runtime_filtering.html">Runtime Filtering</a></li><li><a href="../topics/impala_perf_hdfs_caching.html">HDFS Caching</a></li><li class="active"><a href="../topics/impala_perf_skew.html">HDFS Block Skew</a></li><li><a href="../topics/impala_data_cache.html">Data Cache for Remote Reads</a></li><li><a href="../topics/impala_perf_testing.html">Testing Impala Performance</a></li><li><a href="../topics/impala_explain_plan.html">EXPLAIN Plans and Query Profiles</a></li></ul></li><li><a href="../topics/impala_scalability.html">Scalability Considerations</a></li><li><a href="../topics/impala_resource_management.html">Resource Management</a></li><li><a href="../topics/impala_partitioning.html">Partitioning</a></li><li><a href="../topics/impala_file_formats.html">File Formats</a></li><li><a href="../topics/impala_kudu.html">Using Impala to Query Kudu Tables</a></li><li><a href="../topics/impala_hbase.html">HBase Tables</a></li><li><a href="../topics/impala_iceberg.html">Iceberg Tables</a></li><li><a href="../topics/impala_s3.html">S3 Tables</a></li><li><a href="../topics/impala_adls.html">ADLS Tables</a></li><li><a href="../topics/impala_isilon.html">Isilon Storage</a></li><li><a href="../topics/impala_ozone.html">Ozone Storage</a></li><li><a href="../topics/impala_logging.html">Logging</a></li><li><a href="../topics/impala_client.html">Client Access</a></li><li><a href="../topics/impala_fault_tolerance.html">Fault Tolerance</a></li><li><a href="../topics/impala_troubleshooting.html">Troubleshooting Impala</a></li><li><a href="../topics/impala_ports.html">Ports Used by Impala</a></li><li><a href="../topics/impala_reserved_words.html">Impala Reserved Words</a></li><li><a href="../topics/impala_faq.html">Impala Frequently Asked Questions</a></li><li><a href="../topics/impala_release_notes.html">Impala Release Notes</a></li></ul></nav><main role="main"><article role="article" aria-labelledby="ariaid-title1">

  <h1 class="title topictitle1" id="ariaid-title1">Detecting and Correcting HDFS Block Skew Conditions</h1>
  
  

  <div class="body conbody">

    <p class="p">
      For best performance of Impala parallel queries, the work is divided equally across hosts in the cluster, and
      all hosts take approximately equal time to finish their work. If one host takes substantially longer than
      others, the extra time needed for the slow host can become the dominant factor in query performance.
      Therefore, one of the first steps in performance tuning for Impala is to detect and correct such conditions.
    </p>

    <p class="p">
      The main cause of uneven performance that you can correct within Impala is <dfn class="term">skew</dfn> in the number of
      HDFS data blocks processed by each host, where some hosts process substantially more data blocks than others.
      This condition can occur because of uneven distribution of the data values themselves, for example causing
      certain data files or partitions to be large while others are very small. (Although it is possible to have
      unevenly distributed data without any problems with the distribution of HDFS blocks.) Block skew could also
      be due to the underlying block allocation policies within HDFS, the replication factor of the data files, and
      the way that Impala chooses the host to process each data block.
    </p>

    <p class="p">
      The most convenient way to detect block skew, or slow-host issues in general, is to examine the <span class="q">"executive
      summary"</span> information from the query profile after running a query:
    </p>

    <ul class="ul">
      <li class="li">
        <p class="p">
          In <span class="keyword cmdname">impala-shell</span>, issue the <code class="ph codeph">SUMMARY</code> command immediately after the
          query is complete, to see just the summary information. If you detect issues involving skew, you might
          switch to issuing the <code class="ph codeph">PROFILE</code> command, which displays the summary information followed
          by a detailed performance analysis.
        </p>
      </li>

      <li class="li">
        <p class="p">
          In the Impala debug web UI, click on the <span class="ph uicontrol">Profile</span> link associated with the query after it is
          complete. The executive summary information is displayed early in the profile output.
        </p>
      </li>
    </ul>

    <p class="p">
      For each phase of the query, you see an <span class="ph uicontrol">Avg Time</span> and a <span class="ph uicontrol">Max Time</span>
      value, along with <span class="ph uicontrol">#Hosts</span> indicating how many hosts are involved in that query phase.
      For all the phases with <span class="ph uicontrol">#Hosts</span> greater than one, look for cases where the maximum time
      is substantially greater than the average time. Focus on the phases that took the longest, for example, those
      taking multiple seconds rather than milliseconds or microseconds.
    </p>

    <p class="p">
      If you detect that some hosts take longer than others, first rule out non-Impala causes. One reason that some
      hosts could be slower than others is if those hosts have less capacity than the others, or if they are
      substantially busier due to unevenly distributed non-Impala workloads:
    </p>

    <ul class="ul">
      <li class="li">
        <p class="p">
          For clusters running Impala, keep the relative capacities of all hosts roughly equal. Any cost savings
          from including some underpowered hosts in the cluster will likely be outweighed by poor or uneven
          performance, and the time spent diagnosing performance issues.
        </p>
      </li>

      <li class="li">
        <p class="p">
          If non-Impala workloads cause slowdowns on some hosts but not others, use the appropriate load-balancing
          techniques for the non-Impala components to smooth out the load across the cluster.
        </p>
      </li>
    </ul>

    <p class="p">
      If the hosts on your cluster are evenly powered and evenly loaded, examine the detailed profile output to
      determine which host is taking longer than others for the query phase in question. Examine how many bytes are
      processed during that phase on that host, how much memory is used, and how many bytes are transmitted across
      the network.
    </p>

    <p class="p">
      The most common symptom is a higher number of bytes read on one host than others, due to one host being
      requested to process a higher number of HDFS data blocks. This condition is more likely to occur when the
      number of blocks accessed by the query is relatively small. For example, if you have a 10-node cluster and
      the query processes 10 HDFS blocks, each node might not process exactly one block. If one node sits idle
      while another node processes two blocks, the query could take twice as long as if the data was perfectly
      distributed.
    </p>

    <p class="p">
      Possible solutions in this case include:
    </p>

    <ul class="ul">
      <li class="li">
        <p class="p">
          If the query is artificially small, perhaps for benchmarking purposes, scale it up to process a larger
          data set. For example, if some nodes read 10 HDFS data blocks while others read 11, the overall effect of
          the uneven distribution is much lower than when some nodes did twice as much work as others. As a
          guideline, aim for a <span class="q">"sweet spot"</span> where each node reads 2 GB or more from HDFS per query. Queries
          that process lower volumes than that could experience inconsistent performance that smooths out as
          queries become more data-intensive.
        </p>
      </li>

      <li class="li">
        <p class="p">
          If the query processes only a few large blocks, so that many nodes sit idle and cannot help to
          parallelize the query, consider reducing the overall block size. For example, you might adjust the
          <code class="ph codeph">PARQUET_FILE_SIZE</code> query option before copying or converting data into a Parquet table.
          Or you might adjust the granularity of data files produced earlier in the ETL pipeline by non-Impala
          components. In Impala 2.0 and later, the default Parquet block size is 256 MB, reduced from 1 GB, to
          improve parallelism for common cluster sizes and data volumes.
        </p>
      </li>

      <li class="li">
        <p class="p">
          Reduce the amount of compression applied to the data. For text data files, the highest degree of
          compression (gzip) produces unsplittable files that are more difficult for Impala to process in parallel,
          and require extra memory during processing to hold the compressed and uncompressed data simultaneously.
          For binary formats such as Parquet and Avro, compression can result in fewer data blocks overall, but
          remember that when queries process relatively few blocks, there is less opportunity for parallel
          execution and many nodes in the cluster might sit idle. Note that when Impala writes Parquet data with
          the query option <code class="ph codeph">COMPRESSION_CODEC=NONE</code> enabled, the data is still typically compact due
          to the encoding schemes used by Parquet, independent of the final compression step.
        </p>
      </li>
    </ul>
  </div>
<nav role="navigation" class="related-links"><div class="familylinks"><div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../topics/impala_performance.html">Tuning Impala for Performance</a></div></div></nav></article></main></body></html>